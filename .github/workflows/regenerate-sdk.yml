name: Auto-Regenerate SDK

on:
  schedule:
    # Run daily at 2 AM UTC to check for API changes
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-and-regenerate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Regenerate SDK
        run: |
          echo "ðŸ”§ Regenerating SDK from latest OpenAPI spec..."
          rm -rf src/polar
          crystal run src/generate.cr

      - name: Format generated code
        run: |
          echo "âœ¨ Formatting generated code..."
          crystal tool format

      - name: Check if generated code changed
        id: check_changes
        run: |
          if git diff --quiet src/polar; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes to generated SDK"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… SDK has been updated"
          fi

      - name: Get API version
        if: steps.check_changes.outputs.changed == 'true'
        id: spec_version
        run: |
          SPEC=$(curl -s https://api.polar.sh/openapi.json)
          VERSION=$(echo "$SPEC" | jq -r '.info.version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Polar API version: $VERSION"

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: regenerate SDK from Polar API v${{ steps.spec_version.outputs.version }}

            Auto-generated from updated OpenAPI specification at https://api.polar.sh/openapi.json

            - Regenerated all models and API clients
            - Formatted code with crystal tool format
            - CI will verify build and tests
          branch: auto-update-sdk-${{ github.run_number }}
          delete-branch: true
          title: "ðŸ¤– Auto-update SDK to Polar API v${{ steps.spec_version.outputs.version }}"
          body: |
            ## Auto-Generated SDK Update

            This PR was automatically created by the SDK regeneration workflow.

            ### Changes
            - ðŸ“¥ Updated to Polar API version **${{ steps.spec_version.outputs.version }}**
            - ðŸ”„ Regenerated all models and API clients
            - âœ¨ Formatted code with `crystal tool format`

            ### CI Status
            The CI workflow will automatically:
            - âœ… Verify the SDK builds successfully
            - âœ… Run all specs
            - âœ… Check code formatting
            - âœ… Test the generator works

            ### Review Checklist
            - [ ] Review generated model changes
            - [ ] Review generated API method changes
            - [ ] Check for any breaking changes
            - [ ] Update CHANGELOG.md if needed
            - [ ] Merge if CI passes

            ### Links
            - [Polar API Documentation](https://docs.polar.sh/api)
            - [OpenAPI Spec](https://api.polar.sh/openapi.json)

            ---
            ðŸ¤– Generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            auto-update
            dependencies
          draft: false

      - name: No changes needed
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "âœ… No update needed - SDK is up to date with latest API spec"
